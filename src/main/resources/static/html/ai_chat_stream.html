<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Chat - 流式输出</title>
    <script src="../js/vue.js"></script>
    <script src="../js/axios.min.js"></script>
</head>
<body>
<div id="app">
    <input type="text" v-model="text">
    <button type="button" @click="send()">发送</button>
    <button type="button" @click="cancel()" :disabled="!isStreaming">停止</button><br>
    <div id="output" style="white-space: pre-wrap; min-height: 100px; border: 1px solid #ccc; padding: 10px;">
        {{result}}
    </div>
</div>

<script>
    let v = new Vue({
        el: '#app',
        data: {
            text: "",
            result: "",
            isStreaming: false,
            controller: null
        },
        methods: {
            send() {
                if (this.isStreaming) {
                    alert('请等待当前请求完成');
                    return;
                }

                this.result = ""; // 清空之前的结果
                this.isStreaming = true;

                // 创建 AbortController 用于取消请求
                this.controller = new AbortController();

                // 使用 Fetch API 处理流式响应
                fetch(`http://localhost:8088/ai/chat?prompt=${encodeURIComponent(this.text)}`, {
                    signal: this.controller.signal
                })
                    .then(response => {
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        function read() {
                            return reader.read().then(({ done, value }) => {
                                if (done) {
                                    this.isStreaming = false;
                                    return;
                                }

                                // 解码并追加到结果中
                                const chunk = decoder.decode(value, { stream: true });
                                this.result += chunk;

                                // 继续读取下一块数据
                                return read.call(this);
                            });
                        }

                        return read.call(this);
                    })
                    .catch(error => {
                        if (error.name === 'AbortError') {
                            console.log('请求已被取消');
                        } else {
                            console.error('请求失败:', error);
                            this.result += '\n\n[请求发生错误]';
                        }
                        this.isStreaming = false;
                    });
            },

            cancel() {
                if (this.controller) {
                    this.controller.abort();
                    this.isStreaming = false;
                }
            }
        }
    });
</script>
</body>
</html>
